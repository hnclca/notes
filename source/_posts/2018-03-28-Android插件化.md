---
title: Android插件化
comments: true
toc: true
date: 2018-03-28 14:33:23
tags:
	- android
	- plugin
---

[TOC]

<!-- more -->

### 介绍

#### 关键概念

* 宿主 -- 主工程，提供运行环境
* 插件 -- 独立功能的apk，可在线配置和更新实现插件在宿主中的上下线

#### 优点

* 无需下载更新，减少发版频率，增加用户体验
* 快速修复线上BUG
* 按需加载不同的模块，灵活配置功能，减少服务器对旧版本接口兼容压力
* 模块化、解耦合、并行开发

### 入门知识

#### Binder

#### App打包流程

#### App安装流程

#### App启动流程

#### 资源加载机制

#### Gradle

### 实现原理

* 拷贝可执行文件到App内部
* 加载可执行资源，更换静态资源
	* 动态加载so库
	* 动态加载dex/jar/apk文件
		* DexClassLoader
		* PathClassLoader(不适用) -- 仅能加载已安装的apk文件
	* 资源文件的加载
	* Android生命周期的管理和组件的注册
	* 解决宿主Apk和插件Apk资源引用的冲突
* 调用具体的方法执行业务逻辑

### 主流框架

#### DL动态加载框架

##### 实现原理
基于代理方式实现。注册ProxyXXX组件到清单中，通过代理组件构建、启动插件组件。
需按照一定的规则开发插件APK，插件中的组件需实现改造后的组件类。

##### 优点

* 插件遵循一定的规则，安全可控
* 方案简单，适用于少量代码的插件化改造

##### 缺点

* 不支持this调用组件的方法，需通过that去调用
* 具体组件未注册到清单文件中，不支持隐式调用
* 插件编写和改造过程中，兼容性问题比较多，联调比较费力

#### DroidPlugin

##### 实现原理
提供不完全沙箱功能。

* 共享进程：一进程运行多个Apk，欺骗系统
* 占坑：预先占坑方式实现不用在清单注册，使用一带多方式实现服务管理
* Hook机制：动态代理实现函数hook，Binder代理绕过部分系统服务限制，IO重定向

##### 优点

* 支持四大组件，插件中组件无需在宿主Apk中注册
* 支持2.3系统
* 插件与插件、插件与宿主间的代码和资源完全隔离
* 实现进程管理，插件的空进程会被及时回收

##### 缺点

* 插件Apk不支持自定义资源的Notification，通知栏限制
* 插件Apk中无法注册具有特殊的Intent Filter的四大组件
* 缺乏对Native层的Hook操作，对带有Native代码的插件Apk支持不友好
* 隔离机制，通信只能使用AIDL方式
* 安全性担忧，hook机制
* 机型适配问题（大量使用反射）

#### Small

##### 实现原理
模块命名要遵循一定的规则，如业务模块用app.*，公共库模块用lib.*。
插件中新增activity组件时，需要在宿主中配置路由，再重新编译插件项目。

* 动态加载：so库包装为zip格式，插入到DexPathList中
* 资源分段：资源ID格式为0xPPTTNNNN，pp是包ID，00-02属于系统，7f属于应用程序，03-7e保留用途。使用保留用途的范围解决资源冲突问题
* 动态代理注册：欺骗AMS，预先占坑组件，通过后，还原为真实的组件

##### 优点

* 插件支持宿主内置
* 资源文件无冲突问题
* 使用URI设定，实现宿主、Native应用插件、Web插件、在线网页等通信
* 支持Android、iOS和H5，三者通过同一套Javascript接口通信

##### 缺点

* 不支持Service动态注册

#### VirtualApk

##### 实现原理
对插件无约束。宿主App可直接加载插件Apk，加载后在宿主中创建单独的LoadedPlugin对象，宿主通过LoadedPlugin管理和运行插件。
要求指定版本环境：gradle 2.14.1和android gradle plugins 2.1.3

* 合并宿主和插件的ClassLoader：要求宿主和插件中的类不重复
* 合并宿主和插件的资源：重设插件资源的pacakgeId
* 去除插件包对宿主的引用：构建时使用gradle插件去除插件对宿主代码及资源的引用

##### 优点

* 四大组件无需预注册，每个组件都有完整的生命周期，支持绝大部分Android特性
* 兼容性好，hook少（仅AMS和IContentProvider），插件运行逻辑和宿主隔离
* 入侵性低，插件开发等同于原生开发，无需继承特定基类，精简插件包，插件可依赖也可不依赖宿主中代码和资源，构建过程简单且透明

##### 缺点

* 不支持Service动态注册

#### RePlugin

##### 实现原理


##### 优点

* 灵活性：宿主无需升级（在清单中占坑），即可支持新增组件
* 稳定性：仅Hook了ClassLoader
* 特性丰富：支持近乎所有原生Apk的特性
* 易集成：接入代码少
* 管理成熟：插件管理方案成熟稳定，如安装、升级、卸载、版本管理等